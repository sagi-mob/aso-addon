<script>
  //--------------- REFERSH AS OS Change ----------------//
  function osChanged() {
    GetDocumentApps();
    GetMobileActionApps();
  }


  //--------------- REFERSH APP API FUNCTIONS ----------------//
  function loadAppsKeywords() {
    var mmpid = $('#chosenDocApp :selected').val();
    var country = $('input[name=country]').val();
    var date = $('input[name=date]').val();

    this.disabled = true;
    google.script.run
      .withSuccessHandler(printSuccess)
      .withFailureHandler(printErr)
      .withUserObject(this)
      .loadAppsKeywords(mmpid, country, date);
  }

  function GetDocumentApps() {
    var os = $('input[type=radio]:checked').val();
    google.script.run
      .withSuccessHandler(apps => {
        buildDropdownList(apps[os].sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase())));
      })
      .GetDocumentApps();
  }

  function buildDropdownList(apps) {
    $("#chosenDocApp option").remove();
    $.each(apps, function (key, obj) {
      $("#chosenDocApp").append($("<option>")
        .attr('value', obj["mmpid"])
        .attr('os', obj["os"])
        .attr('name', obj["name"])
        .attr('storeid', obj["storeid"])
        .text(obj["name"]));
    });

  }

  //--------------- TRACK APP FUNCTIONS ----------------//

  function addToTracker() {
    var mmpid = $('#chosenDocApp :selected').val();
    var country = $('input[name=country]').val();

    this.disabled = true;
    google.script.run
      .withSuccessHandler(printSuccess)
      .withFailureHandler(printErr)
      .withUserObject(this)
      .addToTracker(mmpid, country);
  }

  //--------------- DELETE APP FUNCTIONS ----------------//

  function deleteApp() {
    var mmpid = $('#chosenDocApp :selected').val();
    this.disabled = true;
    google.script.run
      .withSuccessHandler(function (msg, element) {
        printSuccess(msg, element)
        GetDocumentApps();
      })
      .withFailureHandler(printErr)
      .withUserObject(this)
      .deleteApp(mmpid);
  }

  //--------------- ADD APP FUNCTIONS ----------------//
  function addApp() {
    var country = $('input[name=country]').val();
    var os = $('#chosenMmpApp :selected').attr('os');
    var storeid = $('#chosenMmpApp :selected').attr('storeid');
    var mmpid = $('#chosenMmpApp :selected').val();
    var name = $('#chosenMmpApp :selected').text();

    this.disabled = true;
    google.script.run
      .withSuccessHandler(function (msg, el) {
        printSuccess(msg, el);
        GetDocumentApps();
      })
      .withFailureHandler(printErr)
      .withUserObject(this)
      .addApp(mmpid, name, os, country, storeid);
  }

  function GetMobileActionApps() {
    var aaContVis = $('div.add-app-cont').css('display') != 'none';
    if (!aaContVis) return;

    google.script.run
      .withSuccessHandler(function (appsList) {
        $("#chosenMmpApp option").remove();
        var os = $('input[type=radio]:checked').val();
        var apps = appsList[os].sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));

        $.each(apps, function (key, obj) {
          $("#chosenMmpApp").append($("<option>")
            .attr('value', obj['mmpid'])
            .attr('os', os)
            .attr('name', obj['name'])
            .attr('storeid', obj['storeid'])
            .text(obj['name']));
        });
      })
      .GetMobileActionApps();
  }

  function printErr(err, element) {
    element.disabled = false;
    $('#loading-indicator').hide();
    var errMsg = err || 'Something went wrong. Please check the add-on logs.';
    $('#error').text(errMsg).show();
    $('#error').delay(4000).fadeOut();
    return false;
  }

  function printSuccess(msg, element) {
    element.disabled = false;
    $('#loading-indicator').hide();
    var sucMsg = msg || 'Done.';
    $('#success').text(sucMsg).show("fast");
    $('#success').delay(2000).fadeOut();
    return false;
  }
</script>